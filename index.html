<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Health">
  <meta name="theme-color" content="#1a1a1a">
  <title>Health Tracker</title>
  
  <!-- Google Identity Services -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif;
      background: #1a1a1a;
      color: #e0e0e0;
      min-height: 100vh;
      padding-bottom: env(safe-area-inset-bottom);
    }
    
    /* Login Screen */
    .login-screen {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 2rem;
      text-align: center;
    }
    .login-screen.hidden { display: none; }
    .login-title {
      font-size: 2rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
      background: linear-gradient(135deg, #7cb88a, #4a9c6d);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .login-subtitle {
      color: #888;
      margin-bottom: 2rem;
    }
    .login-btn {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.875rem 1.5rem;
      background: #fff;
      border: none;
      border-radius: 8px;
      color: #333;
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }
    .login-btn img {
      width: 20px;
      height: 20px;
    }
    .login-error {
      color: #e57373;
      margin-top: 1rem;
      font-size: 0.9rem;
    }
    .login-loading {
      color: #888;
      margin-top: 1rem;
    }
    
    /* Main App */
    .app-container { display: none; }
    .app-container.show { display: block; }
    
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 1.25rem;
      background: #242424;
      border-bottom: 1px solid #333;
      position: sticky;
      top: 0;
      z-index: 10;
      padding-top: calc(1rem + env(safe-area-inset-top));
    }
    .title {
      font-size: 1.5rem;
      font-weight: 600;
      background: linear-gradient(135deg, #7cb88a, #4a9c6d);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .header-buttons {
      display: flex;
      gap: 0.5rem;
    }
    .header-btn {
      padding: 0.4rem 0.7rem;
      background: #333;
      border: 1px solid #444;
      border-radius: 6px;
      color: #e0e0e0;
      font-size: 0.75rem;
      cursor: pointer;
    }
    .header-btn.primary {
      background: #4a7c59;
      border-color: #5a9c69;
    }
    .header-btn.logout {
      background: #5c3a3a;
      border-color: #7c4a4a;
    }
    
    .sync-status {
      display: none;
      padding: 0.5rem 1.25rem;
      background: #2a3a4a;
      border-bottom: 1px solid #3a4a5a;
      font-size: 0.8rem;
      color: #8ab4f8;
      text-align: center;
    }
    .sync-status.show { display: block; }
    .sync-status.error { background: #4a2a2a; border-color: #5a3a3a; color: #f88a8a; }
    .sync-status.success { background: #2a4a3a; border-color: #3a5a4a; color: #8af88a; }
    
    .export-message {
      display: none;
      padding: 0.75rem 1.25rem;
      background: #1f3d2a;
      border-bottom: 1px solid #2d5a3a;
      font-size: 0.875rem;
      color: #7cb88a;
      text-align: center;
    }
    .export-message.show { display: block; }
    
    .quick-add {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 0.75rem;
      padding: 1rem 1.25rem;
      padding-bottom: calc(1rem + env(safe-area-inset-bottom));
      background: #1f1f1f;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      z-index: 50;
      border-top: 1px solid #333;
    }
    .quick-add-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.35rem;
      padding: 0.875rem 0.5rem;
      background: #2a2a2a;
      border: 2px solid;
      border-radius: 12px;
      cursor: pointer;
    }
    .quick-add-btn[data-type="meal"] { border-color: #4a7c59; }
    .quick-add-btn[data-type="meds"] { border-color: #7c4a6b; }
    .quick-add-btn[data-type="symptom"] { border-color: #7c5c4a; }
    .quick-add-btn[data-type="breath"] { border-color: #4a5c7c; }
    .quick-add-btn[data-type="stool"] { border-color: #6b6b4a; }
    .quick-add-btn[data-type="note"] { border-color: #5c5c5c; }
    .quick-add-icon { font-size: 1.5rem; }
    .quick-add-label { font-size: 0.75rem; color: #aaa; font-weight: 500; }
    .timeline { padding: 0.5rem 1.25rem 200px; }
    .empty-state { text-align: center; padding: 3rem 1rem; color: #666; }
    .empty-text { font-size: 1.1rem; margin-bottom: 0.5rem; }
    .empty-subtext { font-size: 0.9rem; color: #555; }
    .day-group { margin-bottom: 1.5rem; }
    .date-header {
      font-size: 0.8rem;
      font-weight: 600;
      color: #888;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 0.75rem;
      padding-left: 0.25rem;
    }
    .entry-card {
      display: flex;
      gap: 0.75rem;
      padding: 0.875rem;
      background: #252525;
      border-radius: 10px;
      margin-bottom: 0.5rem;
      align-items: flex-start;
    }
    .entry-icon {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 36px;
      height: 36px;
      border-radius: 8px;
      font-size: 1.1rem;
      flex-shrink: 0;
    }
    .entry-icon.meal { background: #4a7c59; }
    .entry-icon.meds { background: #7c4a6b; }
    .entry-icon.symptom { background: #7c5c4a; }
    .entry-icon.breath { background: #4a5c7c; }
    .entry-icon.stool { background: #6b6b4a; }
    .entry-icon.note { background: #5c5c5c; }
    .entry-content { flex: 1; min-width: 0; }
    .entry-time { font-size: 0.75rem; color: #888; margin-bottom: 0.25rem; }
    .entry-text { font-size: 0.95rem; color: #e0e0e0; line-height: 1.4; word-break: break-word; }
    .entry-actions { display: flex; gap: 0.25rem; flex-shrink: 0; }
    .action-btn {
      padding: 0.35rem;
      background: transparent;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
      opacity: 0.6;
    }
    .form-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.8);
      align-items: flex-start;
      z-index: 100;
      overflow-y: auto;
    }
    .form-overlay.show { display: flex; }
    .form-container {
      width: 100%;
      min-height: 100vh;
      background: #242424;
      padding: 1.5rem;
      padding-top: calc(1.5rem + env(safe-area-inset-top));
      padding-bottom: calc(100px + env(safe-area-inset-bottom));
    }
    .form-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
    .form-title { font-size: 1.25rem; font-weight: 600; color: #e0e0e0; }
    .close-btn {
      width: 32px; height: 32px;
      display: flex; align-items: center; justify-content: center;
      background: #333; border: none; border-radius: 50%;
      color: #888; font-size: 1rem; cursor: pointer;
    }
    .form-fields { display: flex; flex-direction: column; gap: 1rem; }
    .date-time-row, .breath-fields { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
    .field-group { display: flex; flex-direction: column; gap: 0.4rem; }
    .label { font-size: 0.8rem; font-weight: 500; color: #888; text-transform: uppercase; letter-spacing: 0.03em; }
    .input, .textarea {
      padding: 0.875rem;
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 10px;
      color: #e0e0e0;
      font-size: 1rem;
      font-family: inherit;
      outline: none;
    }
    .textarea { resize: vertical; }
    .rating-buttons { display: flex; gap: 0.5rem; }
    .rating-btn {
      flex: 1; padding: 0.75rem;
      background: #2a2a2a; border: none; border-radius: 8px;
      color: #888; font-size: 1rem; font-weight: 600; cursor: pointer;
    }
    .rating-btn.active { background: #4a7c59; color: #fff; }
    .submit-btn {
      width: 100%; padding: 1rem;
      background: #4a7c59; border: none; border-radius: 12px;
      color: #fff; font-size: 1rem; font-weight: 600; cursor: pointer;
      margin-top: 1.5rem;
    }
    .items-list { display: flex; flex-direction: column; gap: 0.5rem; }
    .item-row {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem;
      background: #1a1a1a;
      border-radius: 8px;
    }
    .item-name { flex: 1; font-size: 0.9rem; color: #e0e0e0; }
    .add-row { display: flex; gap: 0.5rem; align-items: center; }
    .food-name-input {
      flex: 1;
      padding: 0.75rem;
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 8px;
      color: #e0e0e0;
      font-size: 0.9rem;
      outline: none;
    }
    .qty-input {
      width: 50px;
      padding: 0.75rem 0.5rem;
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 8px;
      color: #e0e0e0;
      font-size: 0.9rem;
      outline: none;
      text-align: center;
    }
    .unit-input {
      width: 60px;
      padding: 0.75rem 0.5rem;
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 8px;
      color: #e0e0e0;
      font-size: 0.9rem;
      outline: none;
      text-align: center;
    }
    .add-btn {
      min-width: 48px; 
      width: 48px; 
      height: 48px;
      display: flex; 
      align-items: center; 
      justify-content: center;
      background: #4a7c59; 
      border: none; 
      border-radius: 10px;
      color: #fff; 
      font-size: 1.5rem; 
      font-weight: bold;
      cursor: pointer;
      flex-shrink: 0;
    }
    .remove-btn {
      width: 28px; height: 28px;
      display: flex; align-items: center; justify-content: center;
      background: #5c3a3a; border: none; border-radius: 6px;
      color: #e88; font-size: 0.8rem; cursor: pointer;
    }
    .history-grid { display: flex; flex-wrap: wrap; gap: 0.5rem; }
    .history-chip {
      padding: 0.5rem 0.75rem;
      border: 1px solid #444;
      border-radius: 20px;
      font-size: 0.85rem;
      color: #e0e0e0;
      background: #2a2a2a;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.3rem;
    }
    .history-chip.selected { background: #4a7c59; border-color: #5a9c69; }
    .history-chip.selected.meds { background: #7c4a6b; border-color: #9c6a8b; }
    .history-chip.selected.symptom { background: #7c5c4a; border-color: #9c7c6a; }
    .import-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.8);
      align-items: center;
      justify-content: center;
      z-index: 100;
      padding: 1rem;
    }
    .import-overlay.show { display: flex; }
    .import-container {
      width: 100%;
      max-width: 400px;
      background: #242424;
      border-radius: 16px;
      padding: 1.5rem;
    }
    .import-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }
    .import-title {
      font-size: 1.1rem;
      font-weight: 600;
      color: #e0e0e0;
    }
    .import-textarea {
      width: 100%;
      height: 200px;
      padding: 0.75rem;
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 10px;
      color: #e0e0e0;
      font-size: 0.85rem;
      font-family: monospace;
      resize: none;
      outline: none;
      margin-bottom: 1rem;
    }
    .import-note {
      font-size: 0.8rem;
      color: #888;
      margin-bottom: 1rem;
    }
    .import-buttons {
      display: flex;
      gap: 0.75rem;
    }
    .import-btn {
      flex: 1;
      padding: 0.875rem;
      border: none;
      border-radius: 10px;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
    }
    .import-btn.cancel {
      background: #333;
      color: #e0e0e0;
    }
    .import-btn.confirm {
      background: #4a7c59;
      color: #fff;
    }
    .hidden { display: none !important; }
  </style>
</head>
<body>

  <!-- Login Screen -->
  <div id="loginScreen" class="login-screen">
    <h1 class="login-title">ü©∫ Paul's Health Tracker</h1>
    <p class="login-subtitle">Sign in to access your data</p>
    <button id="loginBtn" class="login-btn" onclick="startGoogleLogin()">
      <svg width="20" height="20" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
      Sign in with Google
    </button>
    <p id="loginError" class="login-error" style="display:none;"></p>
    <p id="loginLoading" class="login-loading" style="display:none;">Signing in...</p>
  </div>

  <!-- Main App -->
  <div id="appContainer" class="app-container">
    <header class="header">
      <h1 class="title">Health Tracker</h1>
      <div class="header-buttons">
        <button class="header-btn" onclick="importCSV()">Import</button>
        <button class="header-btn" onclick="copyToClipboard()">Copy</button>
        <button class="header-btn primary" onclick="exportCSV()">Export</button>
        <button class="header-btn logout" onclick="logout()">Logout</button>
      </div>
    </header>

    <div id="syncStatus" class="sync-status"></div>
    <div id="exportMessage" class="export-message"></div>

    <div class="quick-add">
      <button class="quick-add-btn" data-type="meal" onclick="openForm('meal')">
        <span class="quick-add-icon">üçΩÔ∏è</span>
        <span class="quick-add-label">Meal</span>
      </button>
      <button class="quick-add-btn" data-type="meds" onclick="openForm('meds')">
        <span class="quick-add-icon">üíä</span>
        <span class="quick-add-label">Meds</span>
      </button>
      <button class="quick-add-btn" data-type="symptom" onclick="openForm('symptom')">
        <span class="quick-add-icon">ü©∫</span>
        <span class="quick-add-label">Symptom</span>
      </button>
      <button class="quick-add-btn" data-type="breath" onclick="openForm('breath')">
        <span class="quick-add-icon">üí®</span>
        <span class="quick-add-label">Breath</span>
      </button>
      <button class="quick-add-btn" data-type="stool" onclick="openForm('stool')">
        <span class="quick-add-icon">üí©</span>
        <span class="quick-add-label">Stool</span>
      </button>
      <button class="quick-add-btn" data-type="note" onclick="openForm('note')">
        <span class="quick-add-icon">üìù</span>
        <span class="quick-add-label">Note</span>
      </button>
    </div>

    <div id="timeline" class="timeline">
      <div class="empty-state">
        <p class="empty-text">No entries yet</p>
        <p class="empty-subtext">Tap a button above to start tracking</p>
      </div>
    </div>
  </div>

  <!-- Import Modal -->
  <div id="importOverlay" class="import-overlay">
    <div class="import-container">
      <div class="import-header">
        <h3 class="import-title">üì• Import Data</h3>
        <button class="close-btn" onclick="closeImport()">‚úï</button>
      </div>
      <textarea id="importTextarea" class="import-textarea" placeholder="Paste your CSV backup here..."></textarea>
      <p class="import-note">‚ö†Ô∏è This will replace all current data. Make sure you've exported first if needed.</p>
      <div class="import-buttons">
        <button class="import-btn cancel" onclick="closeImport()">Cancel</button>
        <button class="import-btn confirm" onclick="confirmImport()">Import</button>
      </div>
    </div>
  </div>

  <!-- Entry Form Modal -->
  <div id="formOverlay" class="form-overlay">
    <div class="form-container">
      <div class="form-header">
        <h3 id="formTitle" class="form-title">Add Entry</h3>
        <button class="close-btn" onclick="closeForm()">‚úï</button>
      </div>
      <div class="form-fields">
        <div class="date-time-row">
          <div class="field-group">
            <label class="label">Date</label>
            <input type="date" id="entryDate" class="input">
          </div>
          <div class="field-group">
            <label class="label">Time</label>
            <input type="time" id="entryTime" class="input">
          </div>
        </div>

        <!-- Meal Fields -->
        <div id="mealFields" class="hidden">
          <div id="mealItemsList" class="field-group hidden">
            <label class="label">Current Items</label>
            <div id="mealItemsContainer" class="items-list"></div>
          </div>
          <div class="field-group">
            <label class="label">Add Food Item</label>
            <div class="add-row">
              <input type="text" id="newFoodName" class="food-name-input" placeholder="Food name" oninput="filterFoodHistory(this.value)">
              <input type="text" id="newFoodQty" class="qty-input" placeholder="Qty">
              <input type="text" id="newFoodUnit" class="unit-input" placeholder="Unit">
              <button class="add-btn" onclick="addFoodItem()">+</button>
            </div>
          </div>
          <div id="foodHistoryField" class="field-group hidden">
            <label class="label">Recent Foods (tap to add)</label>
            <div id="foodHistoryGrid" class="history-grid"></div>
          </div>
        </div>

        <!-- Meds Fields -->
        <div id="medsFields" class="hidden">
          <div id="medsItemsList" class="field-group hidden">
            <label class="label">Current Meds</label>
            <div id="medsItemsContainer" class="items-list"></div>
          </div>
          <div class="field-group">
            <label class="label">Add Medication</label>
            <div class="add-row">
              <input type="text" id="newMedName" class="food-name-input" placeholder="Medication name" oninput="filterMedsHistory(this.value)">
              <button class="add-btn" onclick="addMedItem()">+</button>
            </div>
          </div>
          <div id="medsHistoryField" class="field-group hidden">
            <label class="label">Recent Meds (tap to add)</label>
            <div id="medsHistoryGrid" class="history-grid"></div>
          </div>
        </div>

        <!-- Symptom Fields -->
        <div id="symptomFields" class="hidden">
          <div id="symptomItemsList" class="field-group hidden">
            <label class="label">Current Symptoms</label>
            <div id="symptomItemsContainer" class="items-list"></div>
          </div>
          <div class="field-group">
            <label class="label">Add Symptom</label>
            <div class="add-row">
              <input type="text" id="newSymptomName" class="food-name-input" placeholder="Symptom" oninput="filterSymptomHistory(this.value)">
              <button class="add-btn" onclick="addSymptomItem()">+</button>
            </div>
          </div>
          <div id="symptomHistoryField" class="field-group hidden">
            <label class="label">Recent Symptoms (tap to add)</label>
            <div id="symptomHistoryGrid" class="history-grid"></div>
          </div>
        </div>

        <!-- Breath Fields -->
        <div id="breathFields" class="breath-fields hidden">
          <div class="field-group">
            <label class="label">Hydrogen (ppm)</label>
            <input type="number" id="hydrogenInput" class="input" placeholder="0">
          </div>
          <div class="field-group">
            <label class="label">Methane (ppm)</label>
            <input type="number" id="methaneInput" class="input" value="0">
          </div>
        </div>

        <!-- Stool Fields -->
        <div id="stoolFields" class="field-group hidden">
          <label class="label">Bristol Stool Rating (1-7)</label>
          <div class="rating-buttons">
            <button class="rating-btn" onclick="selectRating(1)">1</button>
            <button class="rating-btn" onclick="selectRating(2)">2</button>
            <button class="rating-btn" onclick="selectRating(3)">3</button>
            <button class="rating-btn" onclick="selectRating(4)">4</button>
            <button class="rating-btn" onclick="selectRating(5)">5</button>
            <button class="rating-btn" onclick="selectRating(6)">6</button>
            <button class="rating-btn" onclick="selectRating(7)">7</button>
          </div>
        </div>

        <!-- Note Fields -->
        <div id="noteFields" class="field-group hidden">
          <label class="label">Notes</label>
          <textarea id="noteInput" class="textarea" rows="4" placeholder="Any additional notes..."></textarea>
        </div>
      </div>
      <button class="submit-btn" onclick="submitForm()">Add Entry</button>
    </div>
  </div>

  <script>
    // ===========================================
    // CONFIGURATION
    // ===========================================
    const GOOGLE_CLIENT_ID = '238078542796-p0p2r3r2qkuuhk1d66bnrjnp9sisl52a.apps.googleusercontent.com';
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwwmaq0o9_-V0yVj2s4lEQOmzF-D3A2IO5unAbtBc59oeexXv3k0PcxGXXLpPfdptS0/exec';
    // ===========================================

    const icons = { meal: 'üçΩÔ∏è', meds: 'üíä', symptom: 'ü©∫', breath: 'üí®', stool: 'üí©', note: 'üìù' };
    const labels = { meal: 'Meal', meds: 'Meds', symptom: 'Symptom', breath: 'Breath Test', stool: 'Stool', note: 'Note' };
    
    let accessToken = null;
    let tokenClient = null;
    let tokenExpiry = null;
    let entries = [];
    let foodHistory = [];
    let medsHistory = [];
    let symptomHistory = [];
    let currentType = null;
    let editingId = null;
    let selectedRating = null;
    let mealItems = [];
    let medsItems = [];
    let symptomItems = [];
    let saveTimeout = null;

    // Initialize Google Identity Services
    function initGoogleAuth() {
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: GOOGLE_CLIENT_ID,
        scope: 'email profile',
        callback: handleAuthResponse
      });
      
      // Check for existing token
      const savedToken = localStorage.getItem('health_access_token');
      const savedExpiry = localStorage.getItem('health_token_expiry');
      if (savedToken && savedExpiry) {
        accessToken = savedToken;
        tokenExpiry = parseInt(savedExpiry);
        verifyAndLoadData();
      }
    }

    function startGoogleLogin() {
      document.getElementById('loginError').style.display = 'none';
      document.getElementById('loginLoading').style.display = 'block';
      document.getElementById('loginBtn').style.display = 'none';
      tokenClient.requestAccessToken();
    }

    function handleAuthResponse(response) {
      document.getElementById('loginLoading').style.display = 'none';
      document.getElementById('loginBtn').style.display = 'flex';
      
      if (response.error) {
        showLoginError('Login failed: ' + response.error);
        return;
      }
      
      accessToken = response.access_token;
      // Token expires in ~3600 seconds, store expiry time (with 5 min buffer)
      tokenExpiry = Date.now() + ((response.expires_in || 3600) - 300) * 1000;
      localStorage.setItem('health_access_token', accessToken);
      localStorage.setItem('health_token_expiry', tokenExpiry.toString());
      verifyAndLoadData();
    }

    async function ensureValidToken() {
      // Check if token is expired or will expire soon
      if (!accessToken || !tokenExpiry || Date.now() > tokenExpiry) {
        return new Promise((resolve) => {
          tokenClient.callback = (response) => {
            if (response.error) {
              resolve(false);
              return;
            }
            accessToken = response.access_token;
            tokenExpiry = Date.now() + ((response.expires_in || 3600) - 300) * 1000;
            localStorage.setItem('health_access_token', accessToken);
            localStorage.setItem('health_token_expiry', tokenExpiry.toString());
            resolve(true);
          };
          tokenClient.requestAccessToken({ prompt: '' });
        });
      }
      return true;
    }

    async function verifyAndLoadData() {
      showSyncStatus('Verifying...', '');
      
      // Try to refresh token if expired
      const tokenValid = await ensureValidToken();
      if (!tokenValid) {
        // Token refresh failed, need manual login
        localStorage.removeItem('health_access_token');
        localStorage.removeItem('health_token_expiry');
        accessToken = null;
        tokenExpiry = null;
        document.getElementById('loginScreen').classList.remove('hidden');
        document.getElementById('appContainer').classList.remove('show');
        hideSyncStatus();
        return;
      }
      
      try {
        const response = await fetch(`${APPS_SCRIPT_URL}?action=verify&token=${accessToken}`);
        const data = await response.json();
        
        if (data.error) {
          // If invalid token, try refreshing once more
          if (data.error.includes('Invalid token') || data.error.includes('token')) {
            tokenExpiry = 0; // Force refresh
            const refreshed = await ensureValidToken();
            if (refreshed) {
              // Retry verification with new token
              const retryResponse = await fetch(`${APPS_SCRIPT_URL}?action=verify&token=${accessToken}`);
              const retryData = await retryResponse.json();
              if (!retryData.error) {
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('appContainer').classList.add('show');
                loadDataFromServer();
                return;
              }
            }
          }
          
          localStorage.removeItem('health_access_token');
          localStorage.removeItem('health_token_expiry');
          accessToken = null;
          tokenExpiry = null;
          showLoginError(data.error);
          document.getElementById('loginScreen').classList.remove('hidden');
          document.getElementById('appContainer').classList.remove('show');
          return;
        }
        
        // Success - show app
        document.getElementById('loginScreen').classList.add('hidden');
        document.getElementById('appContainer').classList.add('show');
        
        loadDataFromServer();
        
      } catch (e) {
        showLoginError('Connection error. Please try again.');
        localStorage.removeItem('health_access_token');
        localStorage.removeItem('health_token_expiry');
        accessToken = null;
        tokenExpiry = null;
      }
    }

    async function loadDataFromServer() {
      showSyncStatus('Loading data...', '');
      
      // Ensure we have a valid token
      const tokenValid = await ensureValidToken();
      if (!tokenValid) {
        showSyncStatus('Session expired - please refresh', 'error');
        return;
      }
      
      try {
        const response = await fetch(`${APPS_SCRIPT_URL}?action=getData&token=${accessToken}`);
        const data = await response.json();
        
        if (data.error) {
          // If token error, try refreshing and retry once
          if (data.error.includes('Invalid token') || data.error.includes('token')) {
            tokenExpiry = 0;
            const refreshed = await ensureValidToken();
            if (refreshed) {
              const retryResponse = await fetch(`${APPS_SCRIPT_URL}?action=getData&token=${accessToken}`);
              const retryData = await retryResponse.json();
              if (!retryData.error) {
                entries = retryData.entries || [];
                foodHistory = retryData.foodHistory || [];
                medsHistory = retryData.medsHistory || [];
                symptomHistory = retryData.symptomHistory || [];
                renderTimeline();
                showSyncStatus('Data loaded ‚úì', 'success');
                setTimeout(() => hideSyncStatus(), 2000);
                return;
              }
            }
          }
          showSyncStatus('Error: ' + data.error, 'error');
          return;
        }
        
        entries = data.entries || [];
        foodHistory = data.foodHistory || [];
        medsHistory = data.medsHistory || [];
        symptomHistory = data.symptomHistory || [];
        
        renderTimeline();
        showSyncStatus('Data loaded ‚úì', 'success');
        setTimeout(() => hideSyncStatus(), 2000);
        
      } catch (e) {
        showSyncStatus('Failed to load data', 'error');
      }
    }

    async function saveDataToServer() {
      showSyncStatus('Saving...', '');
      
      // Ensure we have a valid token
      const tokenValid = await ensureValidToken();
      if (!tokenValid) {
        showSyncStatus('Session expired - please refresh', 'error');
        return;
      }
      
      try {
        const data = {
          entries: entries,
          foodHistory: foodHistory,
          medsHistory: medsHistory,
          symptomHistory: symptomHistory
        };
        
        // Use a form-based approach that works with Google Apps Script
        const formData = new FormData();
        formData.append('data', JSON.stringify(data));
        
        const response = await fetch(`${APPS_SCRIPT_URL}?action=saveData&token=${accessToken}`, {
          method: 'POST',
          body: formData
        });
        
        const result = await response.json();
        
        if (result.error) {
          // If token error, try refreshing and retry once
          if (result.error.includes('Invalid token') || result.error.includes('token')) {
            tokenExpiry = 0;
            const refreshed = await ensureValidToken();
            if (refreshed) {
              const retryResponse = await fetch(`${APPS_SCRIPT_URL}?action=saveData&token=${accessToken}`, {
                method: 'POST',
                body: formData
              });
              const retryResult = await retryResponse.json();
              if (!retryResult.error) {
                showSyncStatus('Saved ‚úì', 'success');
                setTimeout(() => hideSyncStatus(), 2000);
                return;
              }
            }
          }
          showSyncStatus('Error: ' + result.error, 'error');
          return;
        }
        
        showSyncStatus('Saved ‚úì', 'success');
        setTimeout(() => hideSyncStatus(), 2000);
        
      } catch (e) {
        console.error('Save error:', e);
        showSyncStatus('Failed to save', 'error');
      }
    }

    function debouncedSave() {
      if (saveTimeout) clearTimeout(saveTimeout);
      saveTimeout = setTimeout(() => saveDataToServer(), 1000);
    }

    function showSyncStatus(text, type) {
      const el = document.getElementById('syncStatus');
      el.textContent = text;
      el.className = 'sync-status show' + (type ? ' ' + type : '');
    }

    function hideSyncStatus() {
      document.getElementById('syncStatus').classList.remove('show');
    }

    function showLoginError(msg) {
      const el = document.getElementById('loginError');
      el.textContent = msg;
      el.style.display = 'block';
    }

    function logout() {
      if (confirm('Sign out? Your data is saved in Google Sheets.')) {
        localStorage.removeItem('health_access_token');
        localStorage.removeItem('health_token_expiry');
        if (accessToken) {
          google.accounts.oauth2.revoke(accessToken);
        }
        accessToken = null;
        tokenExpiry = null;
        location.reload();
      }
    }

    // Wait for Google script to load
    window.onload = function() {
      if (typeof google !== 'undefined') {
        initGoogleAuth();
      } else {
        setTimeout(initGoogleAuth, 500);
      }
      
      // Scroll input into view when focused (for mobile keyboard)
      document.addEventListener('focusin', function(e) {
        if (e.target.matches('input, textarea')) {
          setTimeout(() => {
            e.target.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }, 300);
        }
      });
    };

    function generateId() {
      return Math.random().toString(36).substr(2, 9);
    }

    function openForm(type, isEdit = false) {
      currentType = type;
      if (!isEdit) {
        editingId = null;
        mealItems = [];
        medsItems = [];
        symptomItems = [];
      }
      selectedRating = null;
      
      if (!isEdit) {
        const now = new Date();
        const localDate = now.getFullYear() + '-' + 
          String(now.getMonth() + 1).padStart(2, '0') + '-' + 
          String(now.getDate()).padStart(2, '0');
        const localTime = String(now.getHours()).padStart(2, '0') + ':' + 
          String(now.getMinutes()).padStart(2, '0');
        document.getElementById('entryDate').value = localDate;
        document.getElementById('entryTime').value = localTime;
      }
      
      document.getElementById('formTitle').textContent = `${icons[type]} Add ${labels[type]}`;
      
      ['mealFields', 'medsFields', 'symptomFields', 'breathFields', 'stoolFields', 'noteFields'].forEach(f => {
        document.getElementById(f).classList.add('hidden');
      });
      
      if (type === 'meal') {
        document.getElementById('mealFields').classList.remove('hidden');
        renderFoodHistory();
        renderMealItems();
      }
      if (type === 'meds') {
        document.getElementById('medsFields').classList.remove('hidden');
        renderMedsHistory();
        renderMedsItems();
      }
      if (type === 'symptom') {
        document.getElementById('symptomFields').classList.remove('hidden');
        renderSymptomHistory();
        renderSymptomItems();
      }
      if (type === 'breath') {
        document.getElementById('breathFields').classList.remove('hidden');
        document.getElementById('hydrogenInput').value = '';
        document.getElementById('methaneInput').value = '0';
      }
      if (type === 'stool') {
        document.getElementById('stoolFields').classList.remove('hidden');
        document.querySelectorAll('.rating-btn').forEach(b => b.classList.remove('active'));
      }
      if (type === 'note') {
        document.getElementById('noteFields').classList.remove('hidden');
        document.getElementById('noteInput').value = '';
      }
      
      clearInputs();
      document.getElementById('formOverlay').classList.add('show');
    }

    function closeForm() {
      document.getElementById('formOverlay').classList.remove('show');
      currentType = null;
      editingId = null;
    }

    function clearInputs() {
      document.getElementById('newFoodName').value = '';
      document.getElementById('newFoodQty').value = '';
      document.getElementById('newFoodUnit').value = '';
      document.getElementById('newMedName').value = '';
      document.getElementById('newSymptomName').value = '';
    }

    // Food/Meal functions
    function addFoodItem() {
      const name = document.getElementById('newFoodName').value.trim().toUpperCase();
      if (!name) return;
      const qty = document.getElementById('newFoodQty').value.trim();
      const unit = document.getElementById('newFoodUnit').value.trim();
      mealItems.push({ id: generateId(), name, qty, unit });
      if (!foodHistory.includes(name)) {
        foodHistory.push(name);
      }
      document.getElementById('newFoodName').value = '';
      document.getElementById('newFoodQty').value = '';
      document.getElementById('newFoodUnit').value = '';
      renderMealItems();
      renderFoodHistory();
    }

    function removeMealItem(id) {
      mealItems = mealItems.filter(m => m.id !== id);
      renderMealItems();
      renderFoodHistory();
    }

    function toggleFoodHistory(name) {
      const exists = mealItems.find(m => m.name === name);
      if (exists) {
        mealItems = mealItems.filter(m => m.name !== name);
      } else {
        mealItems.push({ id: generateId(), name, qty: '', unit: '' });
      }
      renderMealItems();
      renderFoodHistory();
    }

    function renderMealItems() {
      const container = document.getElementById('mealItemsContainer');
      const listDiv = document.getElementById('mealItemsList');
      if (mealItems.length === 0) {
        listDiv.classList.add('hidden');
        return;
      }
      listDiv.classList.remove('hidden');
      container.innerHTML = mealItems.map(item => `
        <div class="item-row">
          <span class="item-name">${item.name}</span>
          <input type="text" class="qty-input" value="${item.qty}" placeholder="Qty" onchange="updateMealItem('${item.id}', 'qty', this.value)">
          <input type="text" class="unit-input" value="${item.unit}" placeholder="Unit" onchange="updateMealItem('${item.id}', 'unit', this.value)">
          <button class="remove-btn" onclick="removeMealItem('${item.id}')">‚úï</button>
        </div>
      `).join('');
    }

    function updateMealItem(id, field, value) {
      mealItems = mealItems.map(m => m.id === id ? { ...m, [field]: value } : m);
    }

    function renderFoodHistory() {
      const grid = document.getElementById('foodHistoryGrid');
      const field = document.getElementById('foodHistoryField');
      const filterText = (document.getElementById('newFoodName').value || '').toLowerCase();
      
      // Count frequency of each food in entries
      const foodCounts = {};
      entries.forEach(e => {
        if (e.type === 'meal' && e.meal) {
          e.meal.split(',').forEach(item => {
            const name = item.trim().split('(')[0].trim();
            if (name) {
              foodCounts[name] = (foodCounts[name] || 0) + 1;
            }
          });
        }
      });
      
      // Sort by frequency and take top 10
      const sortedFoods = foodHistory
        .filter(food => food.toLowerCase().includes(filterText))
        .sort((a, b) => (foodCounts[b] || 0) - (foodCounts[a] || 0))
        .slice(0, 10);
      
      if (sortedFoods.length === 0) {
        field.classList.add('hidden');
        return;
      }
      field.classList.remove('hidden');
      grid.innerHTML = sortedFoods.map(food => {
        const isSelected = mealItems.some(m => m.name === food);
        return `<button class="history-chip ${isSelected ? 'selected' : ''}" onclick="toggleFoodHistory('${food.replace(/'/g, "\\'")}')">${isSelected ? '‚úì ' : ''}${food}</button>`;
      }).join('');
    }

    function filterFoodHistory(value) {
      renderFoodHistory();
    }

    // Meds functions
    function addMedItem() {
      const name = document.getElementById('newMedName').value.trim().toUpperCase();
      if (!name) return;
      medsItems.push({ id: generateId(), name });
      if (!medsHistory.includes(name)) {
        medsHistory.push(name);
      }
      document.getElementById('newMedName').value = '';
      renderMedsItems();
      renderMedsHistory();
    }

    function removeMedItem(id) {
      medsItems = medsItems.filter(m => m.id !== id);
      renderMedsItems();
      renderMedsHistory();
    }

    function toggleMedsHistory(name) {
      const exists = medsItems.find(m => m.name === name);
      if (exists) {
        medsItems = medsItems.filter(m => m.name !== name);
      } else {
        medsItems.push({ id: generateId(), name });
      }
      renderMedsItems();
      renderMedsHistory();
    }

    function renderMedsItems() {
      const container = document.getElementById('medsItemsContainer');
      const listDiv = document.getElementById('medsItemsList');
      if (medsItems.length === 0) {
        listDiv.classList.add('hidden');
        return;
      }
      listDiv.classList.remove('hidden');
      container.innerHTML = medsItems.map(item => `
        <div class="item-row">
          <span class="item-name">${item.name}</span>
          <button class="remove-btn" onclick="removeMedItem('${item.id}')">‚úï</button>
        </div>
      `).join('');
    }

    function renderMedsHistory() {
      const grid = document.getElementById('medsHistoryGrid');
      const field = document.getElementById('medsHistoryField');
      const filterText = (document.getElementById('newMedName').value || '').toLowerCase();
      
      // Count frequency of each med in entries
      const medCounts = {};
      entries.forEach(e => {
        if (e.type === 'meds' && e.meds) {
          e.meds.split(',').forEach(item => {
            const name = item.trim();
            if (name) {
              medCounts[name] = (medCounts[name] || 0) + 1;
            }
          });
        }
      });
      
      // Sort by frequency and take top 10
      const sortedMeds = medsHistory
        .filter(med => med.toLowerCase().includes(filterText))
        .sort((a, b) => (medCounts[b] || 0) - (medCounts[a] || 0))
        .slice(0, 10);
      
      if (sortedMeds.length === 0) {
        field.classList.add('hidden');
        return;
      }
      field.classList.remove('hidden');
      grid.innerHTML = sortedMeds.map(med => {
        const isSelected = medsItems.some(m => m.name === med);
        return `<button class="history-chip meds ${isSelected ? 'selected' : ''}" onclick="toggleMedsHistory('${med.replace(/'/g, "\\'")}')">${isSelected ? '‚úì ' : ''}${med}</button>`;
      }).join('');
    }

    function filterMedsHistory(value) {
      renderMedsHistory();
    }

    // Symptom functions
    function addSymptomItem() {
      const name = document.getElementById('newSymptomName').value.trim();
      if (!name) return;
      symptomItems.push({ id: generateId(), name });
      if (!symptomHistory.includes(name)) {
        symptomHistory.push(name);
      }
      document.getElementById('newSymptomName').value = '';
      renderSymptomItems();
      renderSymptomHistory();
    }

    function removeSymptomItem(id) {
      symptomItems = symptomItems.filter(s => s.id !== id);
      renderSymptomItems();
      renderSymptomHistory();
    }

    function toggleSymptomHistory(name) {
      const exists = symptomItems.find(s => s.name === name);
      if (exists) {
        symptomItems = symptomItems.filter(s => s.name !== name);
      } else {
        symptomItems.push({ id: generateId(), name });
      }
      renderSymptomItems();
      renderSymptomHistory();
    }

    function renderSymptomItems() {
      const container = document.getElementById('symptomItemsContainer');
      const listDiv = document.getElementById('symptomItemsList');
      if (symptomItems.length === 0) {
        listDiv.classList.add('hidden');
        return;
      }
      listDiv.classList.remove('hidden');
      container.innerHTML = symptomItems.map(item => `
        <div class="item-row">
          <span class="item-name">${item.name}</span>
          <button class="remove-btn" onclick="removeSymptomItem('${item.id}')">‚úï</button>
        </div>
      `).join('');
    }

    function renderSymptomHistory() {
      const grid = document.getElementById('symptomHistoryGrid');
      const field = document.getElementById('symptomHistoryField');
      const filterText = (document.getElementById('newSymptomName').value || '').toLowerCase();
      
      // Count frequency of each symptom in entries
      const symptomCounts = {};
      entries.forEach(e => {
        if (e.type === 'symptom' && e.symptoms) {
          e.symptoms.split(',').forEach(item => {
            const name = item.trim();
            if (name) {
              symptomCounts[name] = (symptomCounts[name] || 0) + 1;
            }
          });
        }
      });
      
      // Sort by frequency and take top 10
      const sortedSymptoms = symptomHistory
        .filter(symptom => symptom.toLowerCase().includes(filterText))
        .sort((a, b) => (symptomCounts[b] || 0) - (symptomCounts[a] || 0))
        .slice(0, 10);
      
      if (sortedSymptoms.length === 0) {
        field.classList.add('hidden');
        return;
      }
      field.classList.remove('hidden');
      grid.innerHTML = sortedSymptoms.map(symptom => {
        const isSelected = symptomItems.some(s => s.name === symptom);
        return `<button class="history-chip symptom ${isSelected ? 'selected' : ''}" onclick="toggleSymptomHistory('${symptom.replace(/'/g, "\\'")}')">${isSelected ? '‚úì ' : ''}${symptom}</button>`;
      }).join('');
    }

    function filterSymptomHistory(value) {
      renderSymptomHistory();
    }

    function selectRating(n) {
      selectedRating = n;
      document.querySelectorAll('.rating-btn').forEach((b, i) => {
        b.classList.toggle('active', i + 1 === n);
      });
    }

    function submitForm() {
      const entry = {
        id: editingId || generateId(),
        type: currentType,
        date: document.getElementById('entryDate').value,
        time: document.getElementById('entryTime').value,
        createdAt: new Date().toISOString()
      };

      if (currentType === 'meal') {
        entry.mealItems = mealItems;
        entry.meal = mealItems.map(m => {
          let str = m.name;
          if (m.qty) str += ` (${m.qty}${m.unit ? ' ' + m.unit : ''})`;
          return str;
        }).join(', ');
      }
      if (currentType === 'meds') {
        entry.medsItems = medsItems;
        entry.meds = medsItems.map(m => m.name).join(', ');
      }
      if (currentType === 'symptom') {
        entry.symptomItems = symptomItems;
        entry.symptoms = symptomItems.map(s => s.name).join(', ');
      }
      if (currentType === 'breath') {
        entry.hydrogen = document.getElementById('hydrogenInput').value || '0';
        entry.methane = document.getElementById('methaneInput').value || '0';
      }
      if (currentType === 'stool') {
        entry.stoolRating = selectedRating;
      }
      if (currentType === 'note') {
        entry.notes = document.getElementById('noteInput').value;
      }

      if (editingId) {
        entries = entries.map(e => e.id === editingId ? entry : e);
      } else {
        entries.push(entry);
      }
      
      entries.sort((a, b) => new Date(`${b.date}T${b.time}`) - new Date(`${a.date}T${a.time}`));
      renderTimeline();
      debouncedSave();
      closeForm();
    }

    function editEntry(id) {
      const entry = entries.find(e => e.id === id);
      if (!entry) return;
      
      editingId = id;
      currentType = entry.type;
      
      // Parse meal string back into items if mealItems not available
      if (entry.type === 'meal') {
        if (entry.mealItems && entry.mealItems.length > 0) {
          mealItems = entry.mealItems;
        } else if (entry.meal) {
          // Parse "Food Name (qty unit), Food Name 2" format
          mealItems = entry.meal.split(',').map(item => {
            const trimmed = item.trim();
            const match = trimmed.match(/^(.+?)\s*(?:\(([^)]*)\))?$/);
            if (match) {
              const name = match[1].trim();
              const qtyUnit = match[2] ? match[2].trim() : '';
              const qtyMatch = qtyUnit.match(/^(\S+)\s*(.*)$/);
              return {
                id: generateId(),
                name: name,
                qty: qtyMatch ? qtyMatch[1] : '',
                unit: qtyMatch ? qtyMatch[2] : ''
              };
            }
            return { id: generateId(), name: trimmed, qty: '', unit: '' };
          }).filter(m => m.name);
        } else {
          mealItems = [];
        }
      } else {
        mealItems = [];
      }
      
      // Parse meds string back into items
      if (entry.type === 'meds') {
        if (entry.medsItems && entry.medsItems.length > 0) {
          medsItems = entry.medsItems;
        } else if (entry.meds) {
          medsItems = entry.meds.split(',').map(item => ({
            id: generateId(),
            name: item.trim()
          })).filter(m => m.name);
        } else {
          medsItems = [];
        }
      } else {
        medsItems = [];
      }
      
      // Parse symptom string back into items
      if (entry.type === 'symptom') {
        if (entry.symptomItems && entry.symptomItems.length > 0) {
          symptomItems = entry.symptomItems;
        } else if (entry.symptoms) {
          symptomItems = entry.symptoms.split(',').map(item => ({
            id: generateId(),
            name: item.trim()
          })).filter(s => s.name);
        } else {
          symptomItems = [];
        }
      } else {
        symptomItems = [];
      }
      
      openForm(entry.type, true);
      document.getElementById('formTitle').textContent = `${icons[entry.type]} Edit ${labels[entry.type]}`;
      document.getElementById('entryDate').value = entry.date;
      document.getElementById('entryTime').value = entry.time;
      
      if (entry.type === 'meal') {
        renderMealItems();
        renderFoodHistory();
      }
      if (entry.type === 'meds') {
        renderMedsItems();
        renderMedsHistory();
      }
      if (entry.type === 'symptom') {
        renderSymptomItems();
        renderSymptomHistory();
      }
      if (entry.type === 'breath') {
        document.getElementById('hydrogenInput').value = entry.hydrogen || '';
        document.getElementById('methaneInput').value = entry.methane || '0';
      }
      if (entry.type === 'stool' && entry.stoolRating) selectRating(entry.stoolRating);
      if (entry.type === 'note') document.getElementById('noteInput').value = entry.notes || '';
    }

    function deleteEntry(id) {
      entries = entries.filter(e => e.id !== id);
      renderTimeline();
      debouncedSave();
    }

    function formatContent(entry) {
      switch (entry.type) {
        case 'meal': return entry.meal;
        case 'meds': return entry.meds;
        case 'symptom': return entry.symptoms;
        case 'breath': return `H‚ÇÇ: ${entry.hydrogen || '0'} | CH‚ÇÑ: ${entry.methane || '0'}`;
        case 'stool': return `Rating: ${entry.stoolRating}/7`;
        case 'note': return entry.notes;
        default: return '';
      }
    }

    function renderTimeline() {
      const timeline = document.getElementById('timeline');
      
      if (entries.length === 0) {
        timeline.innerHTML = `
          <div class="empty-state">
            <p class="empty-text">No entries yet</p>
            <p class="empty-subtext">Tap a button above to start tracking</p>
          </div>
        `;
        return;
      }

      const groups = {};
      entries.forEach(e => {
        if (!groups[e.date]) groups[e.date] = [];
        groups[e.date].push(e);
      });

      const sortedDates = Object.keys(groups).sort((a, b) => new Date(b) - new Date(a));
      
      let html = '';
      sortedDates.forEach(date => {
        const dayEntries = groups[date].sort((a, b) => b.time.localeCompare(a.time));
        const formatted = new Date(date + 'T12:00:00').toLocaleDateString('en-US', {
          weekday: 'short', month: 'short', day: 'numeric'
        });
        
        html += `<div class="day-group"><div class="date-header">${formatted}</div>`;
        
        dayEntries.forEach(entry => {
          html += `
            <div class="entry-card">
              <div class="entry-icon ${entry.type}">${icons[entry.type]}</div>
              <div class="entry-content">
                <div class="entry-time">${entry.time}</div>
                <div class="entry-text">${formatContent(entry)}</div>
              </div>
              <div class="entry-actions">
                <button class="action-btn" onclick="editEntry('${entry.id}')">‚úèÔ∏è</button>
                <button class="action-btn" onclick="deleteEntry('${entry.id}')">üóëÔ∏è</button>
              </div>
            </div>
          `;
        });
        
        html += '</div>';
      });
      
      timeline.innerHTML = html;
    }

    function generateCSV() {
      const headers = ['EventID', 'Date', 'Time', 'Type', 'MEAL', 'MEDS', 'Symptoms', 'Notes', 'Stool Rating', 'Hydrogen', 'Methane'];
      const rows = entries.map(e => [
        e.id, e.date, e.time, e.type,
        e.meal || '', e.meds || '', e.symptoms || '', e.notes || '',
        e.stoolRating || '', e.hydrogen || '', e.methane || ''
      ]);
      
      const escapeCell = (cell) => {
        let str = String(cell);
        str = str.replace(/[\r\n]+/g, ' ');
        str = str.replace(/"/g, '""');
        return `"${str}"`;
      };
      
      return [headers, ...rows].map(row => row.map(escapeCell).join(',')).join('\n');
    }

    function exportCSV() {
      const csv = generateCSV();
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `health-tracker-${new Date().toISOString().split('T')[0]}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      showMessage('‚úì CSV file downloaded!');
    }

    function copyToClipboard() {
      const csv = generateCSV();
      navigator.clipboard.writeText(csv).then(() => {
        showMessage('‚úì Copied to clipboard!');
      }).catch(() => {
        showMessage('Could not copy. Try Export instead.');
      });
    }

    function showMessage(text) {
      const msg = document.getElementById('exportMessage');
      msg.textContent = text;
      msg.classList.add('show');
      setTimeout(() => msg.classList.remove('show'), 3000);
    }

    function importCSV() {
      document.getElementById('importTextarea').value = '';
      document.getElementById('importOverlay').classList.add('show');
    }

    function closeImport() {
      document.getElementById('importOverlay').classList.remove('show');
    }

    function confirmImport() {
      const csv = document.getElementById('importTextarea').value.trim();
      if (!csv) {
        showMessage('Please paste CSV data first.');
        return;
      }

      try {
        const lines = csv.split('\n');
        if (lines.length < 2) {
          showMessage('Invalid CSV: no data rows found.');
          return;
        }

        const headerLine = lines[0];
        const headers = parseCSVLine(headerLine);
        
        const colIndex = {
          id: headers.findIndex(h => h.toLowerCase().includes('eventid')),
          date: headers.findIndex(h => h.toLowerCase() === 'date'),
          time: headers.findIndex(h => h.toLowerCase() === 'time'),
          type: headers.findIndex(h => h.toLowerCase() === 'type'),
          meal: headers.findIndex(h => h.toLowerCase() === 'meal'),
          meds: headers.findIndex(h => h.toLowerCase() === 'meds'),
          symptoms: headers.findIndex(h => h.toLowerCase() === 'symptoms'),
          notes: headers.findIndex(h => h.toLowerCase() === 'notes'),
          stoolRating: headers.findIndex(h => h.toLowerCase().includes('stool')),
          hydrogen: headers.findIndex(h => h.toLowerCase() === 'hydrogen'),
          methane: headers.findIndex(h => h.toLowerCase() === 'methane')
        };

        const newEntries = [];
        const newFoods = new Set(foodHistory);
        const newMeds = new Set(medsHistory);
        const newSymptoms = new Set(symptomHistory);

        for (let i = 1; i < lines.length; i++) {
          const line = lines[i].trim();
          if (!line) continue;
          
          const cols = parseCSVLine(line);
          const type = cols[colIndex.type] || '';
          
          if (!type) continue;

          const entry = {
            id: cols[colIndex.id] || generateId(),
            type: type,
            date: cols[colIndex.date] || '',
            time: cols[colIndex.time] || '',
            createdAt: new Date().toISOString()
          };

          if (type === 'meal' && cols[colIndex.meal]) {
            entry.meal = cols[colIndex.meal];
            cols[colIndex.meal].split(',').forEach(f => {
              const name = f.trim().split('(')[0].trim();
              if (name) newFoods.add(name);
            });
          }
          if (type === 'meds' && cols[colIndex.meds]) {
            entry.meds = cols[colIndex.meds];
            cols[colIndex.meds].split(',').forEach(m => {
              const name = m.trim();
              if (name) newMeds.add(name);
            });
          }
          if (type === 'symptom' && cols[colIndex.symptoms]) {
            entry.symptoms = cols[colIndex.symptoms];
            cols[colIndex.symptoms].split(',').forEach(s => {
              const name = s.trim();
              if (name) newSymptoms.add(name);
            });
          }
          if (type === 'breath') {
            entry.hydrogen = cols[colIndex.hydrogen] || '0';
            entry.methane = cols[colIndex.methane] || '0';
          }
          if (type === 'stool') {
            entry.stoolRating = parseInt(cols[colIndex.stoolRating]) || null;
          }
          if (type === 'note') {
            entry.notes = cols[colIndex.notes] || '';
          }

          newEntries.push(entry);
        }

        if (newEntries.length === 0) {
          showMessage('No valid entries found in CSV.');
          return;
        }

        entries = newEntries;
        entries.sort((a, b) => new Date(`${b.date}T${b.time}`) - new Date(`${a.date}T${a.time}`));
        foodHistory = Array.from(newFoods);
        medsHistory = Array.from(newMeds);
        symptomHistory = Array.from(newSymptoms);

        renderTimeline();
        saveDataToServer();
        closeImport();
        showMessage(`‚úì Imported ${newEntries.length} entries!`);

      } catch (e) {
        console.error(e);
        showMessage('Error parsing CSV. Check format.');
      }
    }

    function parseCSVLine(line) {
      const result = [];
      let current = '';
      let inQuotes = false;
      
      for (let i = 0; i < line.length; i++) {
        const char = line[i];
        const nextChar = line[i + 1];
        
        if (inQuotes) {
          if (char === '"' && nextChar === '"') {
            current += '"';
            i++;
          } else if (char === '"') {
            inQuotes = false;
          } else {
            current += char;
          }
        } else {
          if (char === '"') {
            inQuotes = true;
          } else if (char === ',') {
            result.push(current);
            current = '';
          } else {
            current += char;
          }
        }
      }
      result.push(current);
      return result;
    }
  </script>
</body>
</html>
